<div class="dm-container" [style.transform]="'translate(-50%, -50%) scale(' + scale + ')'">
  <!-- Header -->
  <div class="dm-header">
    <app-back-button [label]="'DE_BTN_BACK' | translate" route="/driver-manager"
      [queryParams]="{ id: editingDriver?.entity_id }" [confirm]="hasChanges()"
      [confirmTitle]="'DE_CONFIRM_DISCARD_TITLE'" [confirmMessage]="'DE_CONFIRM_DISCARD_MESSAGE'"></app-back-button>

    <!-- Undo/Redo Controls -->
    <app-undo-redo-controls [manager]="undoManager"></app-undo-redo-controls>
  </div>

  <div class="content-area editor-centered" *ngIf="!isLoading">
    <!-- ONLY CONFIGURATION PANELS NOW -->
    <div class="config-panels" *ngIf="editingDriver">
      <!-- DRIVER CONFIG -->
      <div class="panel config-panel">
        <div class="panel-header">{{ 'DE_HEADER_DRIVER_CONFIG' | translate }}</div>
        <div class="config-content driver-config-layout">
          <div class="inputs-column">
            <div class="form-group">
              <label>{{ 'RDS_LABEL_NAME' | translate }}</label>
              <input type="text" [(ngModel)]="editingDriver.name" (ngModelChange)="onInputChange()"
                (focus)="onInputFocus()" (blur)="onInputBlur()" class="dm-input">
            </div>
            <div class="form-group">
              <label>{{ 'RDS_LABEL_NICKNAME' | translate }}</label>
              <input type="text" [(ngModel)]="editingDriver.nickname" (ngModelChange)="onInputChange()"
                (focus)="onInputFocus()" (blur)="onInputBlur()" class="dm-input">
            </div>
          </div>
          <div class="avatar-column">
            <app-image-selector [(imageUrl)]="editingDriver.avatarUrl" (imageUrlChange)="captureState()"
              [assets]="avatarAssets">
            </app-image-selector>
          </div>
        </div>
      </div>

      <!-- AUDIO CONFIG -->
      <div class="panel audio-panel">
        <div class="panel-header">{{ 'DE_HEADER_AUDIO_CONFIG' | translate }}</div>

        <div class="audio-section">
          <app-audio-selector *ngIf="editingDriver?.lapAudio" [label]="'DE_LABEL_LAP_SOUNDS' | translate"
            [assets]="soundAssets" [type]="editingDriver.lapAudio.type"
            (typeChange)="editingDriver.lapAudio.type=$event; captureState()" [url]="editingDriver.lapAudio.url"
            (urlChange)="onInputChange(); editingDriver.lapAudio.url=$event" [text]="editingDriver.lapAudio.text"
            (textChange)="onInputChange(); editingDriver.lapAudio.text=$event" [backButtonRoute]="'/driver-editor'"
            [backButtonQueryParams]="{ id: editingDriver.entity_id }">
          </app-audio-selector>
        </div>

        <div class="audio-section">
          <app-audio-selector *ngIf="editingDriver?.bestLapAudio" [label]="'DE_LABEL_BEST_LAP_SOUNDS' | translate"
            [assets]="soundAssets" [type]="editingDriver.bestLapAudio.type"
            (typeChange)="editingDriver.bestLapAudio.type=$event; captureState()" [url]="editingDriver.bestLapAudio.url"
            (urlChange)="onInputChange(); editingDriver.bestLapAudio.url=$event"
            [text]="editingDriver.bestLapAudio.text"
            (textChange)="onInputChange(); editingDriver.bestLapAudio.text=$event" [backButtonRoute]="'/driver-editor'"
            [backButtonQueryParams]="{ id: editingDriver.entity_id }">
          </app-audio-selector>
        </div>

        <div class="editor-actions">
          <button class="btn btn-update" (click)="updateDriver()" [disabled]="!hasChanges()"
            [title]="hasChanges() ? '' : ('DE_TOOLTIP_NO_CHANGES' | translate)">
            <span class="icon">ðŸ”„</span> {{ 'DE_BTN_UPDATE_DRIVER' | translate }}
          </button>

          <button *ngIf="editingDriver.entity_id !== 'new'" class="btn btn-new" (click)="saveAsNew()"
            [disabled]="!isNameUnique(false) || !isNicknameUnique(false)"
            [title]="(!isNameUnique(false) || !isNicknameUnique(false)) ? ('DE_TOOLTIP_NAME_EXISTS' | translate) : ''">
            <span class="icon">ðŸ’¾</span> {{ 'DE_BTN_SAVE_AS_NEW' | translate }}
          </button>
        </div>

        <div class="more-options">
          <div class="more-btn">
            <span>{{ 'DE_BTN_MORE' | translate }}</span>
            <span class="settings-icon">âš™</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loader-overlay" *ngIf="isLoading || isSaving || isUploading">
    <div class="spinner"></div>
  </div>

  <!-- Connection Lost Overlay -->
  <div class="connection-lost-overlay" *ngIf="isConnectionLost">
    <div class="connection-spinner"></div>
    <div class="connection-lost-text">{{ 'RDS_LOST_CONNECTION' | translate }}</div>
  </div>

</div>